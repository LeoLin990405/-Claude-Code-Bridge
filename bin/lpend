#!/usr/bin/env python3
"""lpend - Fetch latest llama reply from Gateway."""
import json
import sys
import urllib.request
import os

def get_gateway_url():
    return os.environ.get("CCB_GATEWAY_URL", "http://localhost:8765")

def main():
    provider = "llama"
    count = int(sys.argv[1]) if len(sys.argv) > 1 and sys.argv[1].isdigit() else 1
    
    gateway_url = get_gateway_url()
    
    try:
        url = f"{gateway_url}/api/requests?limit=50"
        with urllib.request.urlopen(url, timeout=10) as response:
            requests = json.loads(response.read().decode())
        
        requests = [r for r in requests if r.get("provider") == provider and r.get("status") == "completed"][:count]
        
        if not requests:
            print(f"No completed requests found for {provider}", file=sys.stderr)
            return 1
        
        for req in requests:
            req_id = req.get("id")
            reply_url = f"{gateway_url}/api/reply/{req_id}?wait=false"
            with urllib.request.urlopen(reply_url, timeout=10) as resp:
                reply = json.loads(resp.read().decode())
            
            print(f"=== [{provider}] Request {req_id} ===")
            if reply.get("response"):
                print(reply["response"])
            elif reply.get("error"):
                print(f"Error: {reply['error']}")
            print()
        
        return 0
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1

if __name__ == "__main__":
    sys.exit(main())
