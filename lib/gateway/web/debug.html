<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gateway Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="background:#1a1a2e;color:white;padding:20px;font-family:monospace;">
    <div id="app">
        <h1>Gateway Debug</h1>
        <div style="background:#333;padding:10px;margin:10px 0;border-radius:5px;">
            <h3>Errors:</h3>
            <pre v-for="e in errors" :key="e" style="color:red;">{{ e }}</pre>
            <p v-if="!errors.length" style="color:green;">No errors</p>
        </div>
        <div style="background:#333;padding:10px;margin:10px 0;border-radius:5px;">
            <h3>Logs:</h3>
            <pre v-for="l in logs" :key="l">{{ l }}</pre>
        </div>
        <div style="background:#333;padding:10px;margin:10px 0;border-radius:5px;">
            <h3>WebSocket: {{ wsStatus }}</h3>
        </div>
        <div style="background:#333;padding:10px;margin:10px 0;border-radius:5px;">
            <h3>Chart Test:</h3>
            <canvas ref="testChart" width="300" height="150"></canvas>
        </div>
    </div>
    <script>
        const { createApp, ref, onMounted } = Vue;

        window.onerror = function(msg, url, line, col, error) {
            window._debugErrors = window._debugErrors || [];
            window._debugErrors.push(msg + ' at ' + url + ':' + line + ':' + col);
            return false;
        };

        createApp({
            setup() {
                const errors = ref([]);
                const logs = ref([]);
                const wsStatus = ref('Not connected');
                const testChart = ref(null);

                const log = (msg) => {
                    var now = new Date();
                    logs.value.push('[' + now.toLocaleTimeString() + '] ' + msg);
                };

                onMounted(async () => {
                    if (window._debugErrors) {
                        errors.value = window._debugErrors;
                    }

                    try {
                        log('Fetching /api/status...');
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        log('Status OK: ' + data.providers.length + ' providers');
                    } catch (e) {
                        errors.value.push('API Error: ' + e.message);
                    }

                    try {
                        log('Connecting WebSocket...');
                        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        const ws = new WebSocket(protocol + '//' + window.location.host + '/api/ws');

                        ws.onopen = () => {
                            wsStatus.value = 'Connected';
                            log('WebSocket connected');
                            ws.send(JSON.stringify({ type: 'subscribe', channels: ['all'] }));
                        };

                        ws.onerror = (e) => {
                            wsStatus.value = 'Error';
                            errors.value.push('WebSocket error');
                        };

                        ws.onclose = () => {
                            wsStatus.value = 'Closed';
                            log('WebSocket closed');
                        };

                        ws.onmessage = (e) => {
                            log('WS message received');
                        };
                    } catch (e) {
                        errors.value.push('WebSocket setup error: ' + e.message);
                    }

                    try {
                        log('Initializing Chart.js...');
                        if (testChart.value) {
                            new Chart(testChart.value, {
                                type: 'bar',
                                data: {
                                    labels: ['A', 'B', 'C'],
                                    datasets: [{
                                        label: 'Test',
                                        data: [10, 20, 30],
                                        backgroundColor: 'rgba(99, 102, 241, 0.7)'
                                    }]
                                },
                                options: { responsive: true }
                            });
                            log('Chart.js initialized OK');
                        } else {
                            errors.value.push('Chart canvas ref not found');
                        }
                    } catch (e) {
                        errors.value.push('Chart.js error: ' + e.message);
                    }
                });

                return { errors, logs, wsStatus, testChart };
            }
        }).mount('#app');
    </script>
</body>
</html>
